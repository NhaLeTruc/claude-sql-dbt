version: 2

models:
  - name: customer_analytics
    description: >
      Customer analytics mart with RFM (Recency, Frequency, Monetary) analysis and lifetime value metrics.
      Enables customer behavior analysis, segmentation, and targeted marketing.
      Grain: One row per customer.

      Business Logic:
      - Lifetime value = sum of completed order totals (excludes cancelled/returned)
      - Recency = days since last order
      - Frequency = total number of orders
      - RFM score = combined 1-5 scale score (5 is best)
      - Segmentation based on RFM thresholds
    columns:
      - name: customer_id
        description: Natural key; unique customer identifier from source system
        tests:
          - unique
          - not_null

      - name: customer_name
        description: Customer full name for display and reporting
        tests:
          - not_null

      - name: email
        description: Customer email address for communication
        tests:
          - not_null

      - name: customer_segment
        description: Current customer segment (new, active, at-risk, dormant, vip)
        tests:
          - accepted_values:
              values: ['new', 'active', 'at-risk', 'dormant', 'vip']
              quote: true

      - name: signup_date
        description: Date when customer registered
        tests:
          - not_null

      - name: first_order_date
        description: Date of customer's first completed order (NULL if no orders)

      - name: last_order_date
        description: Date of customer's most recent order (NULL if no orders)

      - name: days_since_last_order
        description: Recency metric - days between last order and current date (NULL if no orders)
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
              config:
                where: "days_since_last_order IS NOT NULL"

      - name: total_orders
        description: Frequency metric - total number of completed orders (excludes cancelled/returned)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: lifetime_value
        description: Monetary metric - total revenue from customer's completed orders (USD)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: average_order_value
        description: Average order size - lifetime_value / total_orders (NULL if no orders)
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
              config:
                where: "average_order_value IS NOT NULL"

      - name: rfm_score
        description: >
          Combined RFM score on 1-5 scale where 5 is best.
          Calculated from recency, frequency, and monetary value percentiles.
          NULL if customer has no orders.
        tests:
          - dbt_utils.expression_is_true:
              expression: "BETWEEN 1 AND 5"
              config:
                where: "rfm_score IS NOT NULL"

      - name: is_active
        description: Boolean flag - TRUE if customer ordered in last 90 days
        tests:
          - not_null
          - accepted_values:
              values: [true, false]

      - name: dbt_updated_at
        description: Timestamp when dbt refreshed this mart
        tests:
          - not_null

  - name: product_performance
    description: >
      Product performance analytics mart for merchandising and inventory decisions.
      Aggregates sales performance, profitability, and ranking metrics per product.
      Grain: One row per product.

      Business Logic:
      - Metrics calculated from completed orders only (excludes cancelled/returned)
      - Category rank based on total revenue within category (1 = highest revenue)
      - Profit margin percentage = (total_profit / total_revenue) * 100
      - Includes products with zero sales for inventory planning
    columns:
      - name: product_id
        description: Natural key; unique product identifier from source system
        tests:
          - unique
          - not_null

      - name: product_name
        description: Product display name
        tests:
          - not_null

      - name: sku
        description: Stock Keeping Unit code
        tests:
          - unique
          - not_null

      - name: category
        description: Product category for grouping and analysis
        tests:
          - not_null

      - name: subcategory
        description: Product subcategory for detailed classification

      - name: total_units_sold
        description: Total quantity sold across all completed orders
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: total_revenue
        description: Total revenue generated from product sales (USD)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: total_profit
        description: Total profit generated from product sales (USD)
        tests:
          - not_null

      - name: total_orders
        description: Number of distinct orders containing this product
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: average_unit_price
        description: Average selling price per unit (NULL if no sales)
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
              config:
                where: "average_unit_price IS NOT NULL"

      - name: profit_margin_pct
        description: Profit margin percentage ((total_profit / total_revenue) * 100); NULL if no sales
        tests:
          - dbt_utils.expression_is_true:
              expression: "BETWEEN 0 AND 100"
              config:
                where: "profit_margin_pct IS NOT NULL"

      - name: category_rank
        description: >
          Rank within category based on total revenue (1 = highest revenue in category).
          Uses DENSE_RANK to handle ties.
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 1"

      - name: is_active
        description: Boolean flag indicating if product is currently available for sale
        tests:
          - not_null
          - accepted_values:
              values: [true, false]

      - name: dbt_updated_at
        description: Timestamp when dbt refreshed this mart
        tests:
          - not_null

  - name: orders_daily
    description: >
      Daily order time-series analytics mart with complete date spine coverage.
      Includes days with zero orders for accurate trend analysis and forecasting.
      Provides YoY growth calculations and cumulative metrics.
      Grain: One row per date (2022-01-01 to 2024-12-31).
    columns:
      - name: date_key
        description: Primary key; date in DATE format
        tests:
          - unique
          - not_null

      - name: day_of_week_name
        description: Day of week name for weekly pattern analysis
        tests:
          - not_null

      - name: month_name
        description: Month name for monthly grouping
        tests:
          - not_null

      - name: year
        description: Year for YoY comparisons
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "BETWEEN 2022 AND 2024"

      - name: total_orders
        description: Number of orders placed on this date (0 for zero-sale days)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: total_revenue
        description: Total revenue generated on this date (USD)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: total_units
        description: Total units sold on this date
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: unique_customers
        description: Number of unique customers who placed orders on this date
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: average_order_value
        description: Average order value for this date (NULL if no orders)
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
              config:
                where: "average_order_value IS NOT NULL"

      - name: cumulative_revenue_ytd
        description: Year-to-date cumulative revenue
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: yoy_growth_pct
        description: Year-over-year growth percentage compared to same date last year (NULL for first year)

      - name: is_weekend
        description: Boolean flag for weekend days
        tests:
          - not_null
          - accepted_values:
              values: [true, false]

      - name: dbt_updated_at
        description: Timestamp when dbt refreshed this mart
        tests:
          - not_null

  - name: orders_weekly
    description: >
      Weekly order time-series analytics mart aggregated from daily data.
      Uses ISO week boundaries (Monday-Sunday).
      Provides week-over-week growth calculations.
      Grain: One row per week.
    columns:
      - name: week_start_date
        description: Primary key; first day of week (Monday)
        tests:
          - unique
          - not_null

      - name: week_end_date
        description: Last day of week (Sunday)
        tests:
          - not_null

      - name: week_number
        description: ISO week number (1-53)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "BETWEEN 1 AND 53"

      - name: year
        description: Year
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "BETWEEN 2021 AND 2024"

      - name: total_orders
        description: Total orders for the week
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: total_revenue
        description: Total revenue for the week (USD)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: total_units
        description: Total units sold during the week
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: unique_customers
        description: Unique customers who ordered during the week
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: average_daily_revenue
        description: Average revenue per day for the week
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: wow_growth_pct
        description: Week-over-week growth percentage (NULL for first week)

      - name: dbt_updated_at
        description: Timestamp when dbt refreshed this mart
        tests:
          - not_null

  - name: orders_monthly
    description: >
      Monthly order time-series analytics mart aggregated from daily data.
      Uses calendar month boundaries.
      Provides month-over-month growth calculations.
      Grain: One row per month.
    columns:
      - name: month_start_date
        description: Primary key; first day of month
        tests:
          - unique
          - not_null

      - name: month
        description: Month number (1-12)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "BETWEEN 1 AND 12"

      - name: month_name
        description: Month name
        tests:
          - not_null

      - name: quarter
        description: Quarter number (1-4)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "BETWEEN 1 AND 4"

      - name: year
        description: Year
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "BETWEEN 2022 AND 2024"

      - name: total_orders
        description: Total orders for the month
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: total_revenue
        description: Total revenue for the month (USD)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: total_units
        description: Total units sold during the month
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: unique_customers
        description: Unique customers who ordered during the month
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: average_daily_revenue
        description: Average revenue per day for the month
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: mom_growth_pct
        description: Month-over-month growth percentage (NULL for first month)

      - name: dbt_updated_at
        description: Timestamp when dbt refreshed this mart
        tests:
          - not_null

  - name: marketing_attribution
    description: >
      Marketing campaign attribution analytics for ROI analysis and channel optimization.
      Uses first-touch attribution: Customer's first order determines campaign attribution.
      Calculates customer acquisition costs (CAC), lifetime value by channel, and ROI.
      Grain: One row per campaign.

      Business Logic:
      - First-touch attribution: campaign_id from customer's first order
      - Customers acquired: COUNT DISTINCT customers with first order attributed to campaign
      - Cost per acquisition (CAC): campaign_budget / customers_acquired
      - Return on investment (ROI): ((total_revenue - campaign_budget) / campaign_budget) * 100
      - Total revenue includes ALL orders from acquired customers (not just first order)
    columns:
      - name: campaign_id
        description: Primary key; unique campaign identifier from campaign_metadata seed
        tests:
          - unique
          - not_null

      - name: campaign_name
        description: Campaign display name for reporting
        tests:
          - not_null

      - name: channel
        description: Marketing channel for campaign (email, social, search, display, affiliate, direct)
        tests:
          - not_null
          - accepted_values:
              values: ['email', 'social', 'search', 'display', 'affiliate', 'direct']
              quote: true

      - name: campaign_start_date
        description: Date when campaign launched
        tests:
          - not_null

      - name: campaign_end_date
        description: Date when campaign ended (NULL for ongoing campaigns)

      - name: campaign_budget
        description: Total budget allocated to campaign (USD)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "> 0"

      - name: customers_acquired
        description: Number of customers acquired through this campaign (first-touch attribution)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: total_orders
        description: Total orders from acquired customers (includes all orders, not just first)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: total_revenue
        description: Total revenue from all orders by acquired customers (USD)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: average_customer_ltv
        description: Average lifetime value of customers acquired through this campaign (NULL if no customers)
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
              config:
                where: "average_customer_ltv IS NOT NULL"

      - name: cost_per_acquisition
        description: >
          Customer acquisition cost (CAC): campaign_budget / customers_acquired.
          NULL if no customers acquired.
        tests:
          - dbt_utils.expression_is_true:
              expression: "> 0"
              config:
                where: "cost_per_acquisition IS NOT NULL"

      - name: return_on_investment_pct
        description: >
          ROI percentage: ((total_revenue - campaign_budget) / campaign_budget) * 100.
          Positive = profitable, negative = loss.
          NULL if no revenue generated.
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= -100"
              config:
                where: "return_on_investment_pct IS NOT NULL"

      - name: is_active
        description: Boolean flag indicating if campaign is currently active (end_date >= CURRENT_DATE or NULL)
        tests:
          - not_null
          - accepted_values:
              values: [true, false]

      - name: dbt_updated_at
        description: Timestamp when dbt refreshed this mart
        tests:
          - not_null
