version: 2

models:
  - name: dim_customers
    description: >
      Customer dimension with SCD Type 1 (current snapshot only).
      Combines customer master data with aggregated order metrics.
      One row per customer showing current state and order history.
      Grain: One row per customer_id.
    columns:
      - name: customer_key
        description: Surrogate key (hash) for customer dimension; used as FK in facts
        tests:
          - unique
          - not_null

      - name: customer_id
        description: Natural key from source system; business key for customer
        tests:
          - unique
          - not_null
          - relationships:
              to: ref('stg_ecommerce__customers')
              field: customer_id

      - name: customer_name
        description: Customer full name for display
        tests:
          - not_null

      - name: email
        description: Customer email address
        tests:
          - not_null

      - name: customer_segment
        description: Current customer segment classification
        tests:
          - accepted_values:
              values: ['new', 'active', 'at-risk', 'dormant', 'vip']
              quote: true

      - name: state
        description: US state code where customer is located

      - name: country
        description: Country where customer is located
        tests:
          - not_null

      - name: signup_date
        description: Date customer registered/signed up
        tests:
          - not_null

      - name: is_active
        description: Boolean flag indicating if customer has placed orders (TRUE if total_orders > 0)
        tests:
          - not_null
          - accepted_values:
              values: [true, false]

      - name: dbt_updated_at
        description: Timestamp when dbt refreshed this dimension
        tests:
          - not_null

  - name: dim_products
    description: >
      Product dimension with SCD Type 1 (current snapshot only).
      Contains product catalog information joined with category hierarchy.
      One row per product showing current state and attributes.
      Grain: One row per product_id.
    columns:
      - name: product_key
        description: Surrogate key (hash) for product dimension; used as FK in facts
        tests:
          - unique
          - not_null

      - name: product_id
        description: Natural key from source system; business key for product
        tests:
          - unique
          - not_null
          - relationships:
              to: ref('stg_ecommerce__products')
              field: product_id

      - name: product_name
        description: Product display name
        tests:
          - not_null

      - name: sku
        description: Stock Keeping Unit code for inventory tracking
        tests:
          - unique
          - not_null

      - name: category
        description: Product category for classification
        tests:
          - not_null

      - name: subcategory
        description: Product subcategory for detailed classification

      - name: unit_cost
        description: Cost per unit (USD)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: list_price
        description: Retail list price per unit (USD)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= unit_cost"
              config:
                severity: warn

      - name: profit_margin_pct
        description: Profit margin percentage
        tests:
          - dbt_utils.expression_is_true:
              expression: "BETWEEN 0 AND 100"

      - name: is_active
        description: Boolean flag indicating if product is available for sale
        tests:
          - not_null
          - accepted_values:
              values: [true, false]

      - name: dbt_updated_at
        description: Timestamp when dbt refreshed this dimension
        tests:
          - not_null

  - name: fact_order_items
    description: >
      Fact table for order line items with incremental loading strategy.
      Contains detailed order item transactions with foreign keys to dimensions.
      Grain: One row per order_item_id (one line per order per product).
      Incremental strategy: Append new order_items only.
    columns:
      - name: order_item_id
        description: Primary key for fact table; unique order line item identifier
        tests:
          - unique
          - not_null

      - name: order_id
        description: Foreign key to orders; identifies which order this item belongs to
        tests:
          - not_null
          - relationships:
              to: ref('stg_ecommerce__orders')
              field: order_id

      - name: product_key
        description: Foreign key to dim_products dimension
        tests:
          - not_null
          - relationships:
              to: ref('dim_products')
              field: product_key

      - name: customer_key
        description: Foreign key to dim_customers dimension (denormalized from order)
        tests:
          - not_null
          - relationships:
              to: ref('dim_customers')
              field: customer_key

      - name: order_date
        description: Date when order was placed (denormalized for partitioning)
        tests:
          - not_null

      - name: quantity
        description: Number of units ordered
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "> 0"

      - name: unit_price
        description: Price per unit at time of order (USD)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: discount
        description: Discount amount applied to line item (USD)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: line_total
        description: Total revenue for this line item
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: line_profit
        description: Profit for this line item (line_total - quantity * unit_cost)
        tests:
          - not_null

      - name: dbt_updated_at
        description: Timestamp when dbt loaded this record
        tests:
          - not_null

  - name: dim_date
    description: >
      Date dimension for time-series analysis using date spine approach.
      Contains one row per date from 2022-01-01 to 2024-12-31.
      Provides calendar attributes for date-based grouping and filtering.
      Grain: One row per date.
    columns:
      - name: date_key
        description: Primary key; date in DATE format (e.g., 2023-01-15)
        tests:
          - unique
          - not_null

      - name: day_of_week
        description: Day of week as integer (1=Monday, 7=Sunday)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "BETWEEN 1 AND 7"

      - name: day_of_week_name
        description: Day of week name (Monday, Tuesday, etc.)
        tests:
          - not_null

      - name: day_of_month
        description: Day of month (1-31)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "BETWEEN 1 AND 31"

      - name: day_of_year
        description: Day of year (1-366)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "BETWEEN 1 AND 366"

      - name: week_of_year
        description: ISO week of year (1-53)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "BETWEEN 1 AND 53"

      - name: month
        description: Month number (1-12)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "BETWEEN 1 AND 12"

      - name: month_name
        description: Month name (January, February, etc.)
        tests:
          - not_null

      - name: quarter
        description: Quarter number (1-4)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "BETWEEN 1 AND 4"

      - name: year
        description: Year (2022-2024 for this demo)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "BETWEEN 2022 AND 2024"

      - name: is_weekend
        description: Boolean flag indicating if date is Saturday or Sunday
        tests:
          - not_null
          - accepted_values:
              values: [true, false]

      - name: is_holiday
        description: Boolean flag indicating if date is a US holiday (placeholder)
        tests:
          - not_null
          - accepted_values:
              values: [true, false]

  - name: fact_orders
    description: >
      Fact table for order headers with customer and date dimensions.
      Contains order-level facts and measures for time-series analysis.
      Grain: One row per order_id.
    columns:
      - name: order_id
        description: Primary key; unique order identifier
        tests:
          - unique
          - not_null

      - name: customer_key
        description: Foreign key to dim_customers dimension
        tests:
          - not_null
          - relationships:
              to: ref('dim_customers')
              field: customer_key

      - name: date_key
        description: Foreign key to dim_date dimension (order date)
        tests:
          - not_null
          - relationships:
              to: ref('dim_date')
              field: date_key

      - name: order_date
        description: Date when order was placed
        tests:
          - not_null

      - name: order_status
        description: Current status of order
        tests:
          - not_null
          - accepted_values:
              values: ['pending', 'processing', 'shipped', 'delivered', 'cancelled', 'returned']
              quote: true

      - name: order_total
        description: Total order amount (USD)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: campaign_id
        description: Campaign attribution (NULL for organic orders)

      - name: created_at
        description: Timestamp when order was created
        tests:
          - not_null

      - name: dbt_updated_at
        description: Timestamp when dbt loaded this record
        tests:
          - not_null
