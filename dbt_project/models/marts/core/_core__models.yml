version: 2

models:
  - name: dim_customers
    description: >
      Customer dimension with SCD Type 1 (current snapshot only).
      Combines customer master data with aggregated order metrics.
      One row per customer showing current state and order history.
      Grain: One row per customer_id.
    columns:
      - name: customer_key
        description: Surrogate key (hash) for customer dimension; used as FK in facts
        tests:
          - unique
          - not_null

      - name: customer_id
        description: Natural key from source system; business key for customer
        tests:
          - unique
          - not_null
          - relationships:
              to: ref('stg_ecommerce__customers')
              field: customer_id

      - name: customer_name
        description: Customer full name for display
        tests:
          - not_null

      - name: email
        description: Customer email address
        tests:
          - not_null

      - name: customer_segment
        description: Current customer segment classification
        tests:
          - accepted_values:
              values: ['new', 'active', 'at-risk', 'dormant', 'vip']
              quote: true

      - name: state
        description: US state code where customer is located

      - name: country
        description: Country where customer is located
        tests:
          - not_null

      - name: signup_date
        description: Date customer registered/signed up
        tests:
          - not_null

      - name: is_active
        description: Boolean flag indicating if customer has placed orders (TRUE if total_orders > 0)
        tests:
          - not_null
          - accepted_values:
              values: [true, false]

      - name: dbt_updated_at
        description: Timestamp when dbt refreshed this dimension
        tests:
          - not_null

  - name: dim_products
    description: >
      Product dimension with SCD Type 1 (current snapshot only).
      Contains product catalog information joined with category hierarchy.
      One row per product showing current state and attributes.
      Grain: One row per product_id.
    columns:
      - name: product_key
        description: Surrogate key (hash) for product dimension; used as FK in facts
        tests:
          - unique
          - not_null

      - name: product_id
        description: Natural key from source system; business key for product
        tests:
          - unique
          - not_null
          - relationships:
              to: ref('stg_ecommerce__products')
              field: product_id

      - name: product_name
        description: Product display name
        tests:
          - not_null

      - name: sku
        description: Stock Keeping Unit code for inventory tracking
        tests:
          - unique
          - not_null

      - name: category
        description: Product category for classification
        tests:
          - not_null

      - name: subcategory
        description: Product subcategory for detailed classification

      - name: unit_cost
        description: Cost per unit (USD)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: list_price
        description: Retail list price per unit (USD)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= unit_cost"
              config:
                severity: warn

      - name: profit_margin_pct
        description: Profit margin percentage
        tests:
          - dbt_utils.expression_is_true:
              expression: "BETWEEN 0 AND 100"

      - name: is_active
        description: Boolean flag indicating if product is available for sale
        tests:
          - not_null
          - accepted_values:
              values: [true, false]

      - name: dbt_updated_at
        description: Timestamp when dbt refreshed this dimension
        tests:
          - not_null

  - name: fact_order_items
    description: >
      Fact table for order line items with incremental loading strategy.
      Contains detailed order item transactions with foreign keys to dimensions.
      Grain: One row per order_item_id (one line per order per product).
      Incremental strategy: Append new order_items only.
    columns:
      - name: order_item_id
        description: Primary key for fact table; unique order line item identifier
        tests:
          - unique
          - not_null

      - name: order_id
        description: Foreign key to orders; identifies which order this item belongs to
        tests:
          - not_null
          - relationships:
              to: ref('stg_ecommerce__orders')
              field: order_id

      - name: product_key
        description: Foreign key to dim_products dimension
        tests:
          - not_null
          - relationships:
              to: ref('dim_products')
              field: product_key

      - name: customer_key
        description: Foreign key to dim_customers dimension (denormalized from order)
        tests:
          - not_null
          - relationships:
              to: ref('dim_customers')
              field: customer_key

      - name: order_date
        description: Date when order was placed (denormalized for partitioning)
        tests:
          - not_null

      - name: quantity
        description: Number of units ordered
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "> 0"

      - name: unit_price
        description: Price per unit at time of order (USD)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: discount
        description: Discount amount applied to line item (USD)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: line_total
        description: Total revenue for this line item
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: line_profit
        description: Profit for this line item (line_total - quantity * unit_cost)
        tests:
          - not_null

      - name: dbt_updated_at
        description: Timestamp when dbt loaded this record
        tests:
          - not_null
